# RTSP 摄像头压力与稳定性测试工具

## 简介

这是一个基于 Python 和 Tkinter 的多线程 RTSP 摄像头压力与稳定性测试工具。它通过模拟大量客户端并发连接并持续拉取 RTSP 视频流，来测试摄像头的承压能力和长期运行的稳定性。

为了最大化性能并降低资源消耗，工具的核心逻辑仅使用 `cv2.VideoCapture` 的 `grab()` 方法来抓取帧数据，而不进行耗时的视频解码，从而将 CPU 占用降至最低。

## 核心功能

- **多线程并发：** 支持同时监控多个 RTSP 地址，并可为每个地址配置多个拉流线程，模拟高并发场景。
- **轻量级监控：** 只抓取帧而不解码，极大地减少了 CPU 资源消耗。
- **实时状态反馈：** GUI 界面实时显示连接状态、重连次数、有效帧率等关键指标。
- **线程安全日志：** 采用线程安全的日志队列，彻底解决了多线程日志混乱和交错的问题，保证日志输出的清晰和有序。
- **后台停止：** 优化了停止监控的逻辑，将耗时的线程清理操作移至后台，确保主 GUI 界面在任何时候都响应迅速，不会卡顿。
- **详细日志记录：** 自动为每个监控线程生成独立的日志文件，便于事后分析。

## 最新版本更新

- **v14：** 彻底解决了日志混乱和交错问题。引入了线程安全的日志队列。
- **v15：** 优化了停止监控的用户体验，使用后台线程来等待线程结束，并提供进度反馈。
- **v16：** 优化了日志别名显示，使用简洁的数字序号。
- **v17：** 改进了多实例日志别名显示，采用 `[序号-拉取次数]` 格式。
- **v18：** 修复了日志别名不连续和鼠标滚轮事件相互干扰的问题。
- **v19：** 修复了日志显示重复线程别名的问题，使日志更简洁。
- **v20：** 移除了 GUI 日志显示中的线程编号，但文件日志中保留。
- **v21：** 修复了上一版本的问题，现在文件日志中不显示线程编号，而 GUI 日志中正常显示。

## 安装与依赖

本项目需要以下依赖库：

- `opencv-python`
- `tkinter` (通常随 Python 默认安装)

您可以使用 pip 安装所需的库：

```
pip install opencv-python

```

## 使用方法

1. **运行脚本：** 直接运行 Python 脚本文件。
2. **添加地址：** 在“RTSP 地址”输入框中填写地址，选择“拉取次数”，然后点击“添加地址”。
3. **启动监控：** 添加完所有地址后，点击“启动监控”按钮。
4. **停止监控：** 随时点击“停止监控”按钮，程序将安全地停止所有监控线程。
5. **查看日志：** 实时日志会显示在主界面的日志输出框中。同时，每个监控线程的详细日志将保存在项目根目录下的 `LOG` 文件夹中。

## 文件结构

```
.
├── 4.py             # 主程序文件
└── LOG/             # 存放所有监控日志的文件夹
    ├── 127.0.0.1_0.log
    ├── 192.168.0.226_1.log
    └── ...

```


-------------------------------------------------

**RTSP 摄像头压力与稳定性测试工具 - 操作说明**

本工具提供了一个直观的图形用户界面（GUI），让您可以轻松地管理和监控 RTSP 视频流。
**界面概览**
界面主要分为四个区域：
1. **顶部输入与控制区：**
    ◦ **RTSP 地址：** 输入要监控的 RTSP 地址。
    ◦ **拉取次数：** 为此地址指定要启动的并发监控线程数量。
    ◦ **监控间隔 (ms)：** 控制每个线程拉取帧的频率，值越低压力越大。
    ◦ **帧率统计间隔 (s)：** 设定多久统计一次有效帧率。
    ◦ **添加地址：** 将地址和拉取次数添加到待监控列表。
    ◦ **批量添加：** 弹出一个新窗口，让您可以一次性粘贴多个地址，每行一个。
2. **待监控地址列表区：**
    ◦ 显示所有已添加的 RTSP 地址及其对应的拉取次数。
    ◦ 您可以点击地址旁的“移除”按钮来删除它。
    ◦ 列表支持鼠标滚轮滚动。
3. **底部控制区：**
    ◦ **启动监控：** 开始所有地址的监控任务。
    ◦ **停止监控：** 安全地终止所有监控线程。在停止过程中，状态栏会显示剩余的线程数。
    ◦ **清空列表：** 移除待监控列表中的所有地址。
    ◦ **状态标签：** 显示当前程序的运行状态（例如：“监控中...”、“已停止”）。
4. **日志输出区：**
    ◦ 实时显示所有监控线程的日志信息。
    ◦ 不同级别的日志（如警告、错误）会以不同颜色显示。
**操作步骤
1. 添加单个 RTSP 地址**
1. 在 “RTSP 地址” 输入框中输入一个有效的 RTSP 地址，例如 `rtsp://admin:password@192.168.1.100/stream1`。
2. 在 “拉取次数” 下拉框中选择您想要为该地址启动的并发线程数量。
3. 点击 “添加地址” 按钮。
4. 该地址会出现在下方的待监控地址列表中。
**2. 批量添加 RTSP 地址**
1. 点击 “批量添加” 按钮。
2. 一个新窗口会弹出，您可以在其中粘贴多行 RTSP 地址，每行一个。
3. 点击 “确认添加” 按钮，所有地址将被自动添加到列表中。
**3. 启动和停止监控**
1. 确认待监控列表中已包含您想要测试的所有地址。
2. 点击 “启动监控” 按钮。
3. 状态标签会变为 “监控中...”，日志区开始实时显示每个线程的连接和拉流状态。
4. 要停止监控，点击 “停止监控” 按钮。
5. 状态标签会显示正在停止的线程数量，并在所有线程安全退出后恢复到 “已停止”。
**日志与监控指标**
• **日志别名：** 在 GUI 日志中，每条消息前的 `[线程-序号]` 别名用于区分不同的监控线程，其中序号是连续递增的。
• **连接成功：** 表示一个监控线程成功连接到了 RTSP 流。
• **连接断开 / 抓取帧失败：** 表示连接中断，线程将根据重连策略进行重试。
• **有效帧率 (FPS)：** 这是一个关键性能指标，显示在设定的时间间隔内，每个线程成功抓取到帧的平均速率。如果帧率过低或不稳定，可能意味着摄像头在当前压力下性能不佳。
• **日志文件：** 所有日志将以 `[IP或域名]_[线程序号].log` 的格式保存在 `LOG` 文件夹中，例如 `192.168.0.226_1.log`。这对于事后分析至关重要。
